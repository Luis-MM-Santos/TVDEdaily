<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TVDE Daily Management</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    table, th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #f4f4f4; }
    input { width: 90px; }
    .btn { padding: 10px 15px; cursor: pointer; margin-top: 10px; }
    h2 { margin-top: 40px; }
    tfoot td { font-weight: bold; background: #e9f7ef; }
    .export-btn { padding: 4px 10px; margin-left: 5px; }
    .delete-btn { background: #d9534f; color: #fff; border: none; border-radius:3px; padding: 4px 8px; cursor:pointer;}
  </style>
</head>
<body>
  <h1>TVDE Daily Management ðŸš–</h1>

  <form id="tvdeForm">
    <label>Date: <input type="date" id="data" required></label><br /><br />
    <label>Uber: <input type="number" id="uber" step="0.01"></label>
    <label>Bolt: <input type="number" id="bolt" step="0.01"></label>
    <label>Tips: <input type="number" id="tips" step="0.01"></label>
    <label>Prizes: <input type="number" id="prizes" step="0.01"></label><br /><br />
    <label>Charging: <input type="number" id="charging" step="0.01"></label>
    <label>Washing: <input type="number" id="washing" step="0.01"></label>
    <label>Tolls: <input type="number" id="tolls" step="0.01"></label>
    <label>Snacks: <input type="number" id="snacks" step="0.01"></label>
    <label>Other: <input type="number" id="other" step="0.01"></label><br /><br />
    <button type="submit" class="btn">Add</button>
  </form>

  <h2>Daily Records</h2>
  <table id="tabela">
    <thead>
      <tr>
        <th>Date</th>
        <th>Uber</th>
        <th>Bolt</th>
        <th>Tips</th>
        <th>Prizes</th>
        <th>Charging</th>
        <th>Washing</th>
        <th>Tolls</th>
        <th>Snacks</th>
        <th>Other</th>
        <th>Net Profit</th>
        <th>Net + 2</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Monthly Summary</h2>
  <table id="resumoMensal">
    <thead>
      <tr>
        <th>Month</th>
        <th>Days</th>
        <th>Uber</th>
        <th>Bolt</th>
        <th>Tips</th>
        <th>Prizes</th>
        <th>Charging</th>
        <th>Washing</th>
        <th>Tolls</th>
        <th>Snacks</th>
        <th>Other</th>
        <th>Net Profit</th>
        <th>Net + 2</th>
        <th>Export</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.0/jspdf.plugin.autotable.min.js"></script>
  <script>
    const form = document.getElementById("tvdeForm");
    const tabela = document.querySelector("#tabela tbody");
    const resumoMensalBody = document.querySelector("#resumoMensal tbody");
    let registros = JSON.parse(localStorage.getItem("tvdeRegistos")) || [];

    function safe(val) {
      let n = Number(val);
      return isNaN(n) ? 0 : n;
    }

    function getMonthName(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      return `${months[d.getMonth()]} ${d.getFullYear()}`;
    }

    function calcNetProfit(uber, bolt) {
      return (safe(uber) * 0.75 + safe(bolt) * 0.80);
    }

    function calcNetPlus2(netProfit, tips) {
      return (safe(netProfit) * 0.5 + safe(tips));
    }

    function renderTabela() {
      tabela.innerHTML = "";
      registros.forEach((r, idx) => {
        let netProfit = calcNetProfit(r.uber, r.bolt);
        let netPlus2 = calcNetPlus2(netProfit, r.tips);
        let row = `<tr>
          <td>${r.date}</td>
          <td>${Number(r.uber).toFixed(2)}</td>
          <td>${Number(r.bolt).toFixed(2)}</td>
          <td>${Number(r.tips).toFixed(2)}</td>
          <td>${Number(r.prizes).toFixed(2)}</td>
          <td>${Number(r.charging).toFixed(2)}</td>
          <td>${Number(r.washing).toFixed(2)}</td>
          <td>${Number(r.tolls).toFixed(2)}</td>
          <td>${Number(r.snacks).toFixed(2)}</td>
          <td>${Number(r.other).toFixed(2)}</td>
          <td>${netProfit.toFixed(2)}</td>
          <td>${netPlus2.toFixed(2)}</td>
          <td><button class="delete-btn" onclick="deleteRegistro(${idx})">Delete</button></td>
        </tr>`;
        tabela.innerHTML += row;
      });
    }

    function atualizarResumoMensal() {
      resumoMensalBody.innerHTML = "";
      if (registros.length === 0) return;
      let resumo = {};

      registros.forEach(r => {
        let mes = getMonthName(r.date);
        if (!resumo[mes]) {
          resumo[mes] = {
            dias: 0, uber: 0, bolt: 0, tips: 0, prizes: 0,
            charging: 0, washing: 0, tolls: 0, snacks: 0, other: 0,
            netProfit: 0, netPlus2: 0
          };
        }
        resumo[mes].dias++;
        resumo[mes].uber += safe(r.uber);
        resumo[mes].bolt += safe(r.bolt);
        resumo[mes].tips += safe(r.tips);
        resumo[mes].prizes += safe(r.prizes);
        resumo[mes].charging += safe(r.charging);
        resumo[mes].washing += safe(r.washing);
        resumo[mes].tolls += safe(r.tolls);
        resumo[mes].snacks += safe(r.snacks);
        resumo[mes].other += safe(r.other);

        let netProfit = calcNetProfit(r.uber, r.bolt);
        let netPlus2 = calcNetPlus2(netProfit, r.tips);
        resumo[mes].netProfit += netProfit;
        resumo[mes].netPlus2 += netPlus2;
      });

      for (let mes in resumo) {
        let r = resumo[mes];
        let row = `<tr>
          <td>${mes}</td>
          <td>${r.dias}</td>
          <td>${r.uber.toFixed(2)}</td>
          <td>${r.bolt.toFixed(2)}</td>
          <td>${r.tips.toFixed(2)}</td>
          <td>${r.prizes.toFixed(2)}</td>
          <td>${r.charging.toFixed(2)}</td>
          <td>${r.washing.toFixed(2)}</td>
          <td>${r.tolls.toFixed(2)}</td>
          <td>${r.snacks.toFixed(2)}</td>
          <td>${r.other.toFixed(2)}</td>
          <td>${r.netProfit.toFixed(2)}</td>
          <td>${r.netPlus2.toFixed(2)}</td>
          <td>
            <button class="export-btn" onclick="exportarMesExcel('${mes}')">Excel</button>
            <button class="export-btn" onclick="exportarMesPDF('${mes}')">PDF</button>
          </td>
        </tr>`;
        resumoMensalBody.innerHTML += row;
      }
    }

    form.addEventListener("submit", e => {
      e.preventDefault();

      let reg = {
        date: form.data.value,
        uber: safe(form.uber.value),
        bolt: safe(form.bolt.value),
        tips: safe(form.tips.value),
        prizes: safe(form.prizes.value),
        charging: safe(form.charging.value),
        washing: safe(form.washing.value),
        tolls: safe(form.tolls.value),
        snacks: safe(form.snacks.value),
        other: safe(form.other.value)
      };

      registros.push(reg);
      localStorage.setItem("tvdeRegistos", JSON.stringify(registros));
      form.reset();
      renderAll();
    });

    function deleteRegistro(idx) {
      if (confirm("Are you sure you want to delete this record?")) {
        registros.splice(idx, 1);
        localStorage.setItem("tvdeRegistos", JSON.stringify(registros));
        renderAll();
      }
    }

    window.deleteRegistro = deleteRegistro;

    function renderAll() {
      renderTabela();
      atualizarResumoMensal();
    }
    renderAll();

    function exportarMesExcel(mes) {
      const registosMes = registros.filter(r => getMonthName(r.date) === mes);

      if (registosMes.length === 0) {
        alert("No records for " + mes);
        return;
      }

      const detalhes = registosMes.map(r => ({
        Date: r.date,
        Uber: Number(r.uber).toFixed(2),
        Bolt: Number(r.bolt).toFixed(2),
        Tips: Number(r.tips).toFixed(2),
        Prizes: Number(r.prizes).toFixed(2),
        Charging: Number(r.charging).toFixed(2),
        Washing: Number(r.washing).toFixed(2),
        Tolls: Number(r.tolls).toFixed(2),
        Snacks: Number(r.snacks).toFixed(2),
        Other: Number(r.other).toFixed(2),
        "Net Profit": calcNetProfit(r.uber, r.bolt).toFixed(2),
        "Net + 2": calcNetPlus2(calcNetProfit(r.uber, r.bolt), r.tips).toFixed(2)
      }));

      // Monthly summary
      let summary = {
        Date: 'Summary',
        Days: registosMes.length,
        Uber: 0, Bolt: 0, Tips: 0, Prizes: 0, Charging: 0, Washing: 0, Tolls: 0, Snacks: 0, Other: 0,
        "Net Profit": 0, "Net + 2": 0
      };
      registosMes.forEach(r => {
        summary.Uber += safe(r.uber);
        summary.Bolt += safe(r.bolt);
        summary.Tips += safe(r.tips);
        summary.Prizes += safe(r.prizes);
        summary.Charging += safe(r.charging);
        summary.Washing += safe(r.washing);
        summary.Tolls += safe(r.tolls);
        summary.Snacks += safe(r.snacks);
        summary.Other += safe(r.other);
        summary["Net Profit"] += calcNetProfit(r.uber, r.bolt);
        summary["Net + 2"] += calcNetPlus2(calcNetProfit(r.uber, r.bolt), r.tips);
      });

      detalhes.push({
        Date: 'Summary',
        Uber: summary.Uber.toFixed(2),
        Bolt: summary.Bolt.toFixed(2),
        Tips: summary.Tips.toFixed(2),
        Prizes: summary.Prizes.toFixed(2),
        Charging: summary.Charging.toFixed(2),
        Washing: summary.Washing.toFixed(2),
        Tolls: summary.Tolls.toFixed(2),
        Snacks: summary.Snacks.toFixed(2),
        Other: summary.Other.toFixed(2),
        "Net Profit": summary["Net Profit"].toFixed(2),
        "Net + 2": summary["Net + 2"].toFixed(2)
      });

      const ws = XLSX.utils.json_to_sheet(detalhes);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, mes);
      XLSX.writeFile(wb, `Resumo_${mes}.xlsx`);
    }

    function exportarMesPDF(mes) {
      const registosMes = registros.filter(r => getMonthName(r.date) === mes);

      if (registosMes.length === 0) {
        alert("No records for " + mes);
        return;
      }

      const doc = new jspdf.jsPDF();

      doc.setFontSize(18);
      doc.text(`TVDE Monthly Report - ${mes}`, 14, 15);

      const columns = ["Date", "Uber", "Bolt", "Tips", "Prizes", "Charging", "Washing",
        "Tolls", "Snacks", "Other", "Net Profit", "Net + 2"];
      const rows = registosMes.map(r => [
        r.date,
        Number(r.uber).toFixed(2),
        Number(r.bolt).toFixed(2),
        Number(r.tips).toFixed(2),
        Number(r.prizes).toFixed(2),
        Number(r.charging).toFixed(2),
        Number(r.washing).toFixed(2),
        Number(r.tolls).toFixed(2),
        Number(r.snacks).toFixed(2),
        Number(r.other).toFixed(2),
        calcNetProfit(r.uber, r.bolt).toFixed(2),
        calcNetPlus2(calcNetProfit(r.uber, r.bolt), r.tips).toFixed(2)
      ]);

      // Summary row
      let summary = {
        Days: registosMes.length,
        Uber: 0, Bolt: 0, Tips: 0, Prizes: 0, Charging: 0, Washing: 0, Tolls: 0, Snacks: 0, Other: 0,
        NetProfit: 0, NetPlus2: 0
      };
      registosMes.forEach(r => {
        summary.Uber += safe(r.uber);
        summary.Bolt += safe(r.bolt);
        summary.Tips += safe(r.tips);
        summary.Prizes += safe(r.prizes);
        summary.Charging += safe(r.charging);
        summary.Washing += safe(r.washing);
        summary.Tolls += safe(r.tolls);
        summary.Snacks += safe(r.snacks);
        summary.Other += safe(r.other);
        summary.NetProfit += calcNetProfit(r.uber, r.bolt);
        summary.NetPlus2 += calcNetPlus2(calcNetProfit(r.uber, r.bolt), r.tips);
      });

      const summaryRow = [
        "Summary",
        summary.Uber.toFixed(2),
        summary.Bolt.toFixed(2),
        summary.Tips.toFixed(2),
        summary.Prizes.toFixed(2),
        summary.Charging.toFixed(2),
        summary.Washing.toFixed(2),
        summary.Tolls.toFixed(2),
        summary.Snacks.toFixed(2),
        summary.Other.toFixed(2),
        summary.NetProfit.toFixed(2),
        summary.NetPlus2.toFixed(2)
      ];
      rows.push(summaryRow);

      doc.autoTable({
        startY: 25,
        head: [columns],
        body: rows
      });

      doc.save(`Resumo_${mes}.pdf`);
    }
  </script>
</body>
</html>
